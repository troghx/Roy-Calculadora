<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Prestamos Universal</title>
    <style>
        :root {
            --bg-1: #0b2742;
            --bg-2: #0f4c6e;
            --bg-3: #1f7a8c;
            --card: #ffffff;
            --card-2: #f7fbff;
            --text: #112035;
            --muted: #4f5f74;
            --line: #d7e1ec;
            --primary: #006d77;
            --primary-2: #00a3b0;
            --danger: #b42318;
            --warning: #b54708;
            --success: #027a48;
            --radius: 16px;
            --shadow: 0 16px 34px rgba(6, 26, 49, 0.15);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html,
        body {
            min-height: 100%;
        }

        body {
            font-family: "Segoe UI", "Arial", sans-serif;
            background:
                radial-gradient(circle at 10% 10%, rgba(255, 255, 255, 0.18), transparent 45%),
                radial-gradient(circle at 90% 20%, rgba(255, 255, 255, 0.1), transparent 45%),
                linear-gradient(130deg, var(--bg-1) 0%, var(--bg-2) 58%, var(--bg-3) 100%);
            color: var(--text);
            padding: clamp(10px, 1.8vw, 20px);
        }

        [hidden],
        .hidden {
            display: none !important;
        }

        .app-shell {
            width: min(1280px, 100%);
            margin: 0 auto;
        }

        .app-header {
            margin-bottom: 18px;
            color: #ffffff;
        }

        .app-header h1 {
            font-size: clamp(1.45rem, 2.1vw, 2.25rem);
            line-height: 1.2;
        }

        .app-header p {
            margin-top: 8px;
            font-size: clamp(0.9rem, 1.1vw, 1.02rem);
            color: rgba(255, 255, 255, 0.9);
        }

        .main-grid {
            display: grid;
            grid-template-columns: minmax(0, 1.1fr) minmax(320px, 0.9fr);
            gap: clamp(14px, 1.8vw, 22px);
            align-items: start;
        }

        .panel-right {
            display: grid;
            gap: clamp(14px, 1.6vw, 20px);
            align-content: start;
        }

        .card {
            background: var(--card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: clamp(14px, 2.2vw, 24px);
        }

        .card h2 {
            font-size: clamp(1.05rem, 1.45vw, 1.35rem);
            margin-bottom: 14px;
            color: var(--text);
        }

        .feedback {
            border-radius: 12px;
            padding: 11px 12px;
            margin-bottom: 14px;
            font-size: 0.92rem;
            line-height: 1.3;
        }

        .feedback.error {
            background: #fef3f2;
            border: 1px solid #fecdca;
            color: var(--danger);
        }

        .feedback.success {
            background: #ecfdf3;
            border: 1px solid #abefc6;
            color: var(--success);
        }

        .tipo-selector {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px;
            margin-bottom: 14px;
        }

        .tipo-option {
            border: 2px solid var(--line);
            border-radius: 12px;
            padding: 12px;
            text-align: left;
            background: #fff;
            color: var(--text);
            cursor: pointer;
            transition: border-color 0.2s ease, transform 0.2s ease, background 0.2s ease;
        }

        .tipo-option strong {
            display: block;
            font-size: 0.96rem;
            margin-bottom: 4px;
        }

        .tipo-option span {
            display: block;
            font-size: 0.8rem;
            color: var(--muted);
            line-height: 1.25;
        }

        .tipo-option.active {
            border-color: var(--primary);
            background: #eef9fa;
        }

        .tipo-option:hover {
            transform: translateY(-1px);
        }

        .input-row {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px;
            margin-bottom: 10px;
        }

        .input-group {
            display: grid;
            gap: 5px;
        }

        .input-group label {
            font-size: 0.86rem;
            font-weight: 600;
            color: var(--muted);
        }

        input,
        select,
        textarea,
        button {
            font: inherit;
        }

        input,
        select,
        textarea {
            width: 100%;
            border: 2px solid var(--line);
            border-radius: 10px;
            padding: 10px 11px;
            min-height: 42px;
            color: var(--text);
            background: #fff;
        }

        textarea {
            resize: vertical;
            min-height: 130px;
        }

        input:focus,
        select:focus,
        textarea:focus,
        button:focus-visible {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 109, 119, 0.16);
        }

        .info-box {
            border-radius: 12px;
            padding: 11px 12px;
            font-size: 0.86rem;
            margin-bottom: 10px;
            line-height: 1.35;
        }

        .info-box.primary {
            background: #eff8ff;
            color: #175cd3;
            border: 1px solid #b2ddff;
        }

        .info-box.success {
            background: #ecfdf3;
            color: var(--success);
            border: 1px solid #abefc6;
        }

        .btn-row {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .btn {
            border: none;
            border-radius: 10px;
            min-height: 42px;
            padding: 10px 12px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, filter 0.2s ease;
        }

        .btn:hover {
            transform: translateY(-1px);
            filter: brightness(0.98);
        }

        .btn-primary {
            color: #fff;
            background: linear-gradient(120deg, var(--primary) 0%, var(--primary-2) 100%);
        }

        .btn-secondary {
            color: #073143;
            background: #d6f4f7;
            border: 1px solid #9fdee5;
        }

        .btn-danger {
            color: #fff;
            background: #c43227;
        }

        .hint {
            margin-top: 8px;
            color: var(--muted);
            font-size: 0.82rem;
        }

        .results {
            color: #fff;
            background: linear-gradient(140deg, #005f73 0%, #0a9396 52%, #26c6da 100%);
            position: sticky;
            top: 10px;
        }

        .results h2 {
            color: #fff;
            border-bottom: 1px solid rgba(255, 255, 255, 0.35);
            padding-bottom: 10px;
            margin-bottom: 10px;
        }

        .result-grid {
            display: grid;
            gap: 8px;
        }

        .result-item {
            background: rgba(255, 255, 255, 0.18);
            border: 1px solid rgba(255, 255, 255, 0.22);
            border-radius: 12px;
            padding: 10px;
        }

        .result-label {
            font-size: 0.8rem;
            opacity: 0.92;
            margin-bottom: 4px;
        }

        .result-value {
            font-size: 1.45rem;
            font-weight: 700;
        }

        .result-value.small {
            font-size: 1rem;
            font-weight: 600;
            line-height: 1.35;
        }

        .result-item.highlight {
            border-color: rgba(255, 255, 255, 0.68);
            background: rgba(255, 255, 255, 0.24);
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            border-radius: 99px;
            background: rgba(255, 255, 255, 0.3);
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            width: 0%;
            height: 100%;
            background: #fff;
            transition: width 0.3s ease;
        }

        .status-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            border-radius: 999px;
            padding: 4px 9px;
            font-size: 0.8rem;
            font-weight: 700;
            letter-spacing: 0.01em;
        }

        .status-ok {
            color: #065f46;
            background: #d1fae5;
        }

        .status-late {
            color: #7a271a;
            background: #fee4e2;
        }

        .status-done {
            color: #164e63;
            background: #cffafe;
        }

        .table-wrap {
            overflow-x: auto;
            border-radius: 10px;
            border: 1px solid var(--line);
        }

        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.87rem;
            min-width: 520px;
        }

        .schedule-table th,
        .schedule-table td {
            text-align: left;
            padding: 9px 10px;
            border-bottom: 1px solid var(--line);
        }

        .schedule-table th {
            background: #f0f7ff;
            color: #123e7a;
            font-size: 0.82rem;
            letter-spacing: 0.01em;
            text-transform: uppercase;
        }

        .row-paid {
            background: #eefdf3;
        }

        .row-overdue {
            background: #fff6f5;
        }

        .row-due {
            background: #fffaeb;
        }

        .row-future {
            background: #f8fafc;
        }

        .history-list {
            display: grid;
            gap: 8px;
        }

        .history-item {
            border: 1px solid var(--line);
            border-radius: 10px;
            padding: 10px;
            background: var(--card-2);
            display: grid;
            gap: 8px;
        }

        .history-title {
            font-size: 0.92rem;
            color: #1b365d;
            font-weight: 700;
        }

        .history-meta {
            font-size: 0.79rem;
            color: var(--muted);
            line-height: 1.3;
        }

        .history-actions {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 8px;
        }

        .history-empty {
            color: var(--muted);
            text-align: center;
            font-size: 0.9rem;
            padding: 8px 0;
        }

        .history-tools {
            margin-top: 10px;
        }

        @media (max-width: 1100px) {
            .main-grid {
                grid-template-columns: 1fr;
            }

            .results {
                position: static;
            }
        }

        @media (max-width: 760px) {
            .tipo-selector,
            .input-row,
            .btn-row,
            .history-actions {
                grid-template-columns: 1fr;
            }

            .card {
                border-radius: 12px;
                padding: 12px;
            }
        }

        @media (max-height: 800px) and (min-width: 1101px) {
            body {
                padding: 10px;
            }

            .app-header {
                margin-bottom: 12px;
            }

            .card {
                padding: 12px 14px;
            }

            .history {
                max-height: 260px;
                overflow: auto;
            }
        }

        @media (prefers-reduced-motion: reduce) {
            * {
                transition: none !important;
                animation: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="app-shell">
        <header class="app-header">
            <h1>Calculadora de Prestamos Universal</h1>
            <p>Compatible con GitHub Pages: sin backend, guardado local y calculos en el navegador.</p>
        </header>

        <main class="main-grid">
            <section class="card" aria-labelledby="datosHeading">
                <h2 id="datosHeading">Datos del prestamo</h2>

                <div id="feedback" class="feedback hidden" role="status" aria-live="polite"></div>

                <div class="tipo-selector" role="group" aria-label="Tipo de prestamo">
                    <button class="tipo-option active" type="button" data-tipo="frecuencia" aria-pressed="true">
                        <strong>Por frecuencia</strong>
                        <span>Pagos semanales, quincenales o mensuales.</span>
                    </button>
                    <button class="tipo-option" type="button" data-tipo="calendario" aria-pressed="false">
                        <strong>Por calendario</strong>
                        <span>Fechas exactas segun contrato.</span>
                    </button>
                </div>

                <form id="prestamoForm" novalidate>
                    <div class="input-row">
                        <div class="input-group">
                            <label for="nombreAcreedor">Nombre del acreedor</label>
                            <input type="text" id="nombreAcreedor" autocomplete="organization">
                        </div>
                        <div class="input-group">
                            <label for="idContrato">ID del contrato</label>
                            <input type="text" id="idContrato" autocomplete="off">
                        </div>
                    </div>

                    <div class="input-row">
                        <div class="input-group">
                            <label for="fechaAcuerdo">Fecha del acuerdo</label>
                            <input type="date" id="fechaAcuerdo">
                        </div>
                        <div class="input-group">
                            <label for="fechaActual">Fecha actual</label>
                            <input type="date" id="fechaActual">
                        </div>
                    </div>

                    <div class="input-row">
                        <div class="input-group">
                            <label for="totalPagos">Monto total del contrato</label>
                            <input type="number" id="totalPagos" step="0.01" min="0">
                        </div>
                        <div class="input-group">
                            <label for="montoPago">Monto por cuota</label>
                            <input type="number" id="montoPago" step="0.01" min="0">
                        </div>
                    </div>

                    <section id="modo-frecuencia">
                        <div class="info-box primary">
                            Se calcula el numero de pagos esperados desde la fecha de acuerdo.
                        </div>
                        <div class="input-row">
                            <div class="input-group">
                                <label for="frecuencia">Frecuencia de pago</label>
                                <select id="frecuencia">
                                    <option value="7">Semanal (7 dias)</option>
                                    <option value="14">Quincenal (14 dias)</option>
                                    <option value="15">Quincenal (15 dias)</option>
                                    <option value="30">Mensual (30 dias)</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="pagosRealizadosManual">Pagos realizados (opcional)</label>
                                <input type="number" id="pagosRealizadosManual" min="0" step="1" placeholder="Auto">
                            </div>
                        </div>
                    </section>

                    <section id="modo-calendario" hidden>
                        <div class="info-box primary">
                            Ingresa una fecha por linea en formato YYYY-MM-DD. Puedes generarlas por semana, quincena o mensual.
                        </div>
                        <div class="input-row">
                            <div class="input-group">
                                <label for="primeraFechaPago">Primera fecha de pago</label>
                                <input type="date" id="primeraFechaPago">
                            </div>
                            <div class="input-group">
                                <label for="numeroTotalPagos">Numero total de pagos</label>
                                <input type="number" id="numeroTotalPagos" min="1" step="1">
                            </div>
                        </div>
                        <div class="input-row">
                            <div class="input-group">
                                <label for="frecuenciaCalendario">Frecuencia del calendario</label>
                                <select id="frecuenciaCalendario">
                                    <option value="semanal">Semanal</option>
                                    <option value="quincenal" selected>Quincenal</option>
                                    <option value="mensual">Mensual</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="montoUltimoPago">Monto del ultimo pago (opcional)</label>
                                <input type="number" id="montoUltimoPago" min="0" step="0.01">
                            </div>
                        </div>
                        <div class="input-row">
                            <div class="input-group" style="grid-column: 1 / -1;">
                                <label for="calendarioPagos">Fechas de pago</label>
                                <textarea id="calendarioPagos" rows="8" placeholder="2026-01-15&#10;2026-01-29&#10;2026-02-12"></textarea>
                            </div>
                        </div>
                        <div class="btn-row">
                            <button id="btnGenerarCalendario" class="btn btn-secondary" type="button">Generar calendario automatico</button>
                            <button id="btnAnalizarCalendario" class="btn btn-secondary" type="button">Analizar calendario</button>
                        </div>
                    </section>

                    <div class="input-row" style="margin-top: 10px;">
                        <div class="input-group">
                            <label for="taxes">Impuestos o cargos adicionales</label>
                            <input type="number" id="taxes" step="0.01" value="0">
                        </div>
                        <div class="input-group">
                            <label for="historialMaximo">Maximo historial visible</label>
                            <input type="number" id="historialMaximo" min="5" max="20" step="1" value="10">
                        </div>
                    </div>

                    <div class="btn-row">
                        <button id="btnCalcular" class="btn btn-primary" type="button">Calcular balance</button>
                        <button id="btnLimpiar" class="btn btn-danger" type="button">Limpiar formulario</button>
                    </div>
                </form>

                <p class="hint">Atajo: <strong>Ctrl + Enter</strong> para calcular.</p>
            </section>

            <aside class="panel-right">
                <section id="results" class="card results hidden" aria-live="polite">
                    <h2>Resumen del prestamo</h2>
                    <div class="result-grid">
                        <div class="result-item">
                            <div class="result-label">Acreedor</div>
                            <div class="result-value small" id="resNombre">-</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Contrato</div>
                            <div class="result-value small" id="resId">-</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Estado</div>
                            <div class="result-value small" id="resStatus">-</div>
                        </div>
                        <div class="result-item highlight">
                            <div class="result-label">Balance actual</div>
                            <div class="result-value" id="resBalance">$0.00</div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressBar"></div>
                            </div>
                            <div class="result-label" style="margin-top: 6px;">
                                <span id="porcentajePagado">0%</span> pagado
                            </div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Pagos realizados</div>
                            <div class="result-value small" id="resPagosRealizados">0 pagos</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Total pagado</div>
                            <div class="result-value small" id="resTotalPagado">$0.00</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Pagos restantes</div>
                            <div class="result-value small" id="resPagosRestantes">0 pagos</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Proximo pago</div>
                            <div class="result-value small" id="resProximoPago">-</div>
                        </div>
                    </div>
                </section>

                <section id="calendarioResults" class="card hidden" aria-live="polite">
                    <h2>Calendario de pagos</h2>
                    <div class="table-wrap">
                        <table class="schedule-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Fecha</th>
                                    <th>Monto</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody id="tablaCalendarioBody"></tbody>
                        </table>
                    </div>
                </section>

                <section class="card history" aria-labelledby="historyHeading">
                    <h2 id="historyHeading">Historial</h2>
                    <div id="historialLista" class="history-list"></div>
                    <div class="history-tools">
                        <button id="btnLimpiarHistorial" class="btn btn-secondary" type="button">Limpiar historial</button>
                    </div>
                </section>
            </aside>
        </main>
    </div>

    <script>
        const STORAGE_KEYS = {
            history: "prestamoHistorial",
            lastData: "prestamoLastData"
        };

        const FIELD_IDS = [
            "nombreAcreedor",
            "idContrato",
            "fechaAcuerdo",
            "fechaActual",
            "totalPagos",
            "montoPago",
            "frecuencia",
            "pagosRealizadosManual",
            "primeraFechaPago",
            "numeroTotalPagos",
            "frecuenciaCalendario",
            "montoUltimoPago",
            "calendarioPagos",
            "taxes",
            "historialMaximo"
        ];

        const currency = new Intl.NumberFormat("es-ES", {
            style: "currency",
            currency: "USD",
            minimumFractionDigits: 2
        });

        let tipoActual = "frecuencia";
        let historial = [];

        document.addEventListener("DOMContentLoaded", () => {
            bindEvents();
            applyDefaultValues();
            loadLastData();
            historial = normalizeHistory(safeReadJSON(STORAGE_KEYS.history, []));
            renderHistory();
            setTipo(tipoActual, false);
        });

        function bindEvents() {
            document.querySelectorAll("[data-tipo]").forEach((button) => {
                button.addEventListener("click", () => setTipo(button.dataset.tipo));
            });

            document.getElementById("btnCalcular").addEventListener("click", calcular);
            document.getElementById("btnLimpiar").addEventListener("click", limpiarFormulario);
            document.getElementById("btnGenerarCalendario").addEventListener("click", generarCalendarioAutomatico);
            document.getElementById("btnAnalizarCalendario").addEventListener("click", analizarCalendario);
            document.getElementById("btnLimpiarHistorial").addEventListener("click", limpiarHistorial);

            document.getElementById("historialLista").addEventListener("click", (event) => {
                const loadBtn = event.target.closest("[data-history-load]");
                if (loadBtn) {
                    cargarDesdeHistorial(Number(loadBtn.dataset.historyLoad));
                    return;
                }

                const deleteBtn = event.target.closest("[data-history-delete]");
                if (deleteBtn) {
                    eliminarItemHistorial(Number(deleteBtn.dataset.historyDelete));
                }
            });

            document.addEventListener("keydown", (event) => {
                if (event.ctrlKey && event.key === "Enter") {
                    calcular();
                }
            });
        }

        function applyDefaultValues() {
            const today = parseISODate(getTodayISO());
            const fechaAcuerdo = addDays(today, -135);
            const primeraFecha = addDays(today, -120);

            setValue("nombreAcreedor", "CreditNinja");
            setValue("idContrato", "8814712");
            setValue("fechaActual", formatISODate(today));
            setValue("fechaAcuerdo", formatISODate(fechaAcuerdo));
            setValue("totalPagos", "2554.14");
            setValue("montoPago", "134.44");
            setValue("frecuencia", "14");
            setValue("pagosRealizadosManual", "");
            setValue("primeraFechaPago", formatISODate(primeraFecha));
            setValue("numeroTotalPagos", "19");
            setValue("frecuenciaCalendario", "quincenal");
            setValue("montoUltimoPago", "134.22");
            setValue("taxes", "0");
            setValue("historialMaximo", "10");

            generarCalendarioEjemplo();
            hideResults();
        }

        function setTipo(tipo, save = true) {
            tipoActual = tipo === "calendario" ? "calendario" : "frecuencia";

            document.querySelectorAll("[data-tipo]").forEach((button) => {
                const active = button.dataset.tipo === tipoActual;
                button.classList.toggle("active", active);
                button.setAttribute("aria-pressed", String(active));
            });

            const modoFrecuencia = document.getElementById("modo-frecuencia");
            const modoCalendario = document.getElementById("modo-calendario");

            if (tipoActual === "frecuencia") {
                modoFrecuencia.hidden = false;
                modoCalendario.hidden = true;
                document.getElementById("calendarioResults").classList.add("hidden");
            } else {
                modoFrecuencia.hidden = true;
                modoCalendario.hidden = false;
            }

            if (save) {
                saveLastData();
            }
        }

        function calcular() {
            clearFeedback();

            const data = collectFormData();
            if (!data) {
                return;
            }

            const resultado = tipoActual === "frecuencia"
                ? calcularPorFrecuencia(data)
                : calcularPorCalendario(data);

            if (!resultado) {
                return;
            }

            renderResults(data, resultado);
            saveLastData();
            guardarEnHistorial(data, resultado);
        }

        function collectFormData() {
            const nombre = document.getElementById("nombreAcreedor").value.trim() || "No especificado";
            const idContrato = document.getElementById("idContrato").value.trim() || "No especificado";
            const fechaAcuerdo = parseISODate(document.getElementById("fechaAcuerdo").value);
            const fechaActual = parseISODate(document.getElementById("fechaActual").value);
            const totalPagos = parseInputNumber("totalPagos");
            const montoPago = parseInputNumber("montoPago");
            const taxesRaw = document.getElementById("taxes").value.trim();
            const taxes = taxesRaw === "" ? 0 : parseInputNumber("taxes");
            const pagosManualRaw = document.getElementById("pagosRealizadosManual").value.trim();
            const pagosManual = pagosManualRaw === "" ? null : Number(pagosManualRaw);
            const frecuencia = Number(document.getElementById("frecuencia").value);
            const montoUltimoRaw = document.getElementById("montoUltimoPago").value.trim();
            const montoUltimo = montoUltimoRaw === "" ? null : Number(montoUltimoRaw);
            const historialMaximo = Number(document.getElementById("historialMaximo").value || "10");

            if (!fechaAcuerdo || !fechaActual) {
                showFeedback("Ingresa fechas validas para acuerdo y fecha actual.");
                return null;
            }

            if (!Number.isFinite(totalPagos) || totalPagos <= 0) {
                showFeedback("El monto total del contrato debe ser mayor que cero.");
                return null;
            }

            if (!Number.isFinite(montoPago) || montoPago <= 0) {
                showFeedback("El monto por cuota debe ser mayor que cero.");
                return null;
            }

            if (!Number.isFinite(taxes)) {
                showFeedback("Impuestos/cargos contiene un valor invalido.");
                return null;
            }

            if (totalPagos + taxes <= 0) {
                showFeedback("La suma de total + impuestos/cargos debe ser mayor que cero.");
                return null;
            }

            if (pagosManual !== null && (!Number.isFinite(pagosManual) || pagosManual < 0 || !Number.isInteger(pagosManual))) {
                showFeedback("Pagos realizados manuales debe ser un entero mayor o igual a cero.");
                return null;
            }

            if (!Number.isFinite(frecuencia) || frecuencia <= 0) {
                showFeedback("Selecciona una frecuencia de pago valida.");
                return null;
            }

            if (montoUltimo !== null && (!Number.isFinite(montoUltimo) || montoUltimo < 0)) {
                showFeedback("Monto del ultimo pago invalido.");
                return null;
            }

            return {
                nombre,
                idContrato,
                fechaAcuerdo,
                fechaActual,
                totalPagos,
                montoPago,
                taxes,
                pagosManual,
                frecuencia,
                montoUltimo,
                historialMaximo: clamp(historialMaximo, 5, 20)
            };
        }

        function calcularPorFrecuencia(data) {
            const diasTranscurridos = diffInDays(data.fechaAcuerdo, data.fechaActual);
            let pagosRealizados = data.pagosManual;
            if (pagosRealizados === null) {
                pagosRealizados = diasTranscurridos < data.frecuencia ? 0 : Math.floor(diasTranscurridos / data.frecuencia);
            }

            pagosRealizados = Math.max(0, pagosRealizados);
            const totalConCargos = data.totalPagos + data.taxes;
            const totalPagado = pagosRealizados * data.montoPago;
            const balance = Math.max(0, totalConCargos - totalPagado);
            const pagosRestantes = balance === 0 ? 0 : Math.ceil(balance / data.montoPago);
            const porcentajePagado = totalConCargos > 0 ? Math.min((totalPagado / totalConCargos) * 100, 100) : 0;
            const proximoPagoDate = balance === 0
                ? null
                : addDays(data.fechaAcuerdo, (pagosRealizados + 1) * data.frecuencia);

            return {
                tipo: "frecuencia",
                totalConCargos,
                totalPagado,
                balance,
                pagosRealizados,
                pagosRestantes,
                porcentajePagado,
                proximoPagoDate,
                vencido: false,
                calendario: []
            };
        }

        function calcularPorCalendario(data) {
            const fechas = parseCalendarLines(document.getElementById("calendarioPagos").value);
            if (!fechas.length) {
                showFeedback("Debes ingresar al menos una fecha de pago en el calendario.");
                return null;
            }

            let pagosEsperadosHastaHoy = 0;
            fechas.forEach((fecha) => {
                if (fecha.getTime() <= data.fechaActual.getTime()) {
                    pagosEsperadosHastaHoy += 1;
                }
            });

            let pagosRealizados = data.pagosManual === null ? pagosEsperadosHastaHoy : data.pagosManual;
            pagosRealizados = clamp(pagosRealizados, 0, fechas.length);

            const montoUltimo = data.montoUltimo === null ? data.montoPago : data.montoUltimo;
            const regularPaid = Math.min(pagosRealizados, Math.max(fechas.length - 1, 0));
            const ultimoPagoPagado = pagosRealizados >= fechas.length ? 1 : 0;
            const totalPagado = (regularPaid * data.montoPago) + (ultimoPagoPagado * montoUltimo);
            const totalConCargos = data.totalPagos + data.taxes;
            const balance = Math.max(0, totalConCargos - totalPagado);
            const pagosRestantes = balance === 0 ? 0 : Math.ceil(balance / data.montoPago);
            const porcentajePagado = totalConCargos > 0 ? Math.min((totalPagado / totalConCargos) * 100, 100) : 0;
            const proximoPagoDate = pagosRealizados < fechas.length ? fechas[pagosRealizados] : null;
            const vencido = data.pagosManual !== null && data.pagosManual < pagosEsperadosHastaHoy;

            const calendario = fechas.map((fecha, index) => {
                const esUltimo = index === fechas.length - 1;
                const monto = esUltimo ? montoUltimo : data.montoPago;
                const isPaid = index < pagosRealizados;
                const isPast = fecha.getTime() < data.fechaActual.getTime();
                const isToday = fecha.getTime() === data.fechaActual.getTime();

                let estado = "Pendiente";
                let clase = "row-future";

                if (isPaid) {
                    estado = "Pagado";
                    clase = "row-paid";
                } else if (isPast) {
                    estado = "Vencido";
                    clase = "row-overdue";
                } else if (isToday) {
                    estado = "Pago hoy";
                    clase = "row-due";
                }

                return {
                    index: index + 1,
                    fecha,
                    monto,
                    estado,
                    clase
                };
            });

            return {
                tipo: "calendario",
                totalConCargos,
                totalPagado,
                balance,
                pagosRealizados,
                pagosRestantes,
                porcentajePagado,
                proximoPagoDate,
                vencido,
                calendario
            };
        }

        function renderResults(data, result) {
            document.getElementById("resNombre").textContent = data.nombre;
            document.getElementById("resId").textContent = data.idContrato;
            document.getElementById("resBalance").textContent = currency.format(result.balance);
            document.getElementById("resPagosRealizados").textContent = result.pagosRealizados + " pagos";
            document.getElementById("resTotalPagado").textContent = currency.format(result.totalPagado);
            document.getElementById("resPagosRestantes").textContent = result.pagosRestantes + " pagos";
            document.getElementById("porcentajePagado").textContent = result.porcentajePagado.toFixed(1) + "%";
            document.getElementById("progressBar").style.width = result.porcentajePagado.toFixed(1) + "%";

            const proximoPagoText = result.proximoPagoDate
                ? formatDisplayDate(result.proximoPagoDate)
                : "Prestamo completado";
            document.getElementById("resProximoPago").textContent = proximoPagoText;

            const statusElement = document.getElementById("resStatus");
            if (result.balance === 0) {
                statusElement.innerHTML = '<span class="status-pill status-done">Completado</span>';
            } else if (result.tipo === "calendario" && result.vencido) {
                statusElement.innerHTML = '<span class="status-pill status-late">Pago vencido</span>';
            } else {
                statusElement.innerHTML = '<span class="status-pill status-ok">Al dia</span>';
            }

            document.getElementById("results").classList.remove("hidden");

            if (result.tipo === "calendario") {
                renderCalendarTable(result.calendario);
            } else {
                document.getElementById("calendarioResults").classList.add("hidden");
            }
        }

        function renderCalendarTable(rows) {
            const body = document.getElementById("tablaCalendarioBody");
            body.innerHTML = "";

            rows.forEach((row) => {
                const tr = document.createElement("tr");
                tr.className = row.clase;
                tr.innerHTML = [
                    "<td>" + row.index + "</td>",
                    "<td>" + formatDisplayDate(row.fecha) + "</td>",
                    "<td>" + currency.format(row.monto) + "</td>",
                    "<td>" + row.estado + "</td>"
                ].join("");
                body.appendChild(tr);
            });

            document.getElementById("calendarioResults").classList.remove("hidden");
        }

        function analizarCalendario() {
            clearFeedback();

            const fechaActual = parseISODate(document.getElementById("fechaActual").value);
            if (!fechaActual) {
                showFeedback("Ingresa una fecha actual valida para analizar el calendario.");
                return;
            }

            const fechas = parseCalendarLines(document.getElementById("calendarioPagos").value);
            if (!fechas.length) {
                showFeedback("No hay fechas validas para analizar.");
                return;
            }

            let pagosEsperados = 0;
            let proximoPago = null;

            for (let i = 0; i < fechas.length; i += 1) {
                if (fechas[i].getTime() <= fechaActual.getTime()) {
                    pagosEsperados += 1;
                } else if (!proximoPago) {
                    proximoPago = fechas[i];
                }
            }

            document.getElementById("pagosRealizadosManual").value = String(pagosEsperados);
            showFeedback(
                "Analisis completado: " +
                pagosEsperados + " pagos esperados hasta " + formatDisplayDate(fechaActual) +
                ". Proximo pago: " + (proximoPago ? formatDisplayDate(proximoPago) : "no hay"),
                "success"
            );
        }

        function generarCalendarioAutomatico() {
            clearFeedback();

            const primeraFecha = parseISODate(document.getElementById("primeraFechaPago").value);
            const numeroPagos = Number(document.getElementById("numeroTotalPagos").value);
            const frecuenciaConfig = getCalendarFrequencyConfig();

            if (!primeraFecha) {
                showFeedback("Ingresa una primera fecha valida para generar el calendario.");
                return;
            }

            if (!Number.isFinite(numeroPagos) || numeroPagos <= 0 || !Number.isInteger(numeroPagos)) {
                showFeedback("Numero total de pagos invalido.");
                return;
            }

            const fechas = [];
            for (let i = 0; i < numeroPagos; i += 1) {
                fechas.push(formatISODate(frecuenciaConfig.getDateAt(primeraFecha, i)));
            }

            document.getElementById("calendarioPagos").value = fechas.join("\n");

            if (!document.getElementById("fechaAcuerdo").value) {
                document.getElementById("fechaAcuerdo").value = formatISODate(addDays(primeraFecha, -(frecuenciaConfig.days + 2)));
            }

            showFeedback("Calendario generado con " + numeroPagos + " pagos " + frecuenciaConfig.label + ".", "success");
        }

        function limpiarFormulario() {
            const ok = window.confirm("Se limpiara el formulario y los resultados. Deseas continuar?");
            if (!ok) {
                return;
            }

            applyDefaultValues();
            setTipo("frecuencia", false);
            safeRemove(STORAGE_KEYS.lastData);
            showFeedback("Formulario restablecido.", "success");
        }

        function guardarEnHistorial(data, result) {
            const maximo = data.historialMaximo;
            const snapshot = collectSnapshot();

            historial.unshift({
                fecha: new Date().toLocaleString("es-ES"),
                tipo: tipoActual,
                nombre: data.nombre,
                id: data.idContrato,
                balance: result.balance,
                pagosRealizados: result.pagosRealizados,
                formData: snapshot
            });

            if (historial.length > maximo) {
                historial = historial.slice(0, maximo);
            }

            safeWriteJSON(STORAGE_KEYS.history, historial);
            renderHistory();
        }

        function renderHistory() {
            const container = document.getElementById("historialLista");
            if (!historial.length) {
                container.innerHTML = '<p class="history-empty">No hay calculos recientes.</p>';
                return;
            }

            container.innerHTML = historial.map((item, index) => {
                return [
                    '<article class="history-item">',
                    "<div>",
                    '<p class="history-title">' + escapeHtml(item.nombre || "Sin nombre") + " - " + escapeHtml(item.id || "Sin ID") + "</p>",
                    '<p class="history-meta">' +
                    "Balance: " + currency.format(Number(item.balance || 0)) +
                    " | Pagos: " + Number(item.pagosRealizados || 0) +
                    " | Tipo: " + escapeHtml(item.tipo || "-") +
                    " | " + escapeHtml(item.fecha || "-") +
                    "</p>",
                    "</div>",
                    '<div class="history-actions">',
                    '<button class="btn btn-secondary" type="button" data-history-load="' + index + '">Cargar</button>',
                    '<button class="btn btn-danger" type="button" data-history-delete="' + index + '">Borrar</button>',
                    "</div>",
                    "</article>"
                ].join("");
            }).join("");
        }

        function cargarDesdeHistorial(index) {
            const item = historial[index];
            if (!item || !item.formData || typeof item.formData !== "object") {
                showFeedback("No se pudo cargar el item del historial.");
                return;
            }

            restoreSnapshot(item.formData);
            setTipo(item.formData.tipo || item.tipo || "frecuencia", false);
            calcular();
        }

        function eliminarItemHistorial(index) {
            if (!Number.isInteger(index) || index < 0 || index >= historial.length) {
                return;
            }

            historial.splice(index, 1);
            safeWriteJSON(STORAGE_KEYS.history, historial);
            renderHistory();
        }

        function limpiarHistorial() {
            if (!historial.length) {
                return;
            }

            const ok = window.confirm("Se eliminara el historial completo. Deseas continuar?");
            if (!ok) {
                return;
            }

            historial = [];
            safeWriteJSON(STORAGE_KEYS.history, historial);
            renderHistory();
        }

        function saveLastData() {
            safeWriteJSON(STORAGE_KEYS.lastData, collectSnapshot());
        }

        function loadLastData() {
            const saved = safeReadJSON(STORAGE_KEYS.lastData, null);
            if (!saved || typeof saved !== "object") {
                return;
            }

            restoreSnapshot(saved);
            setTipo(saved.tipo || "frecuencia", false);
        }

        function collectSnapshot() {
            const snapshot = { tipo: tipoActual };
            FIELD_IDS.forEach((id) => {
                const element = document.getElementById(id);
                if (element) {
                    snapshot[id] = element.value;
                }
            });
            return snapshot;
        }

        function restoreSnapshot(snapshot) {
            FIELD_IDS.forEach((id) => {
                if (Object.prototype.hasOwnProperty.call(snapshot, id)) {
                    setValue(id, String(snapshot[id] ?? ""));
                }
            });
        }

        function parseCalendarLines(text) {
            const rawLines = String(text || "")
                .split(/\r?\n/)
                .map((line) => line.trim())
                .filter(Boolean);

            const set = new Set();
            const dates = [];
            const invalid = [];

            rawLines.forEach((line) => {
                const date = parseISODate(line);
                if (!date) {
                    invalid.push(line);
                    return;
                }

                const key = formatISODate(date);
                if (!set.has(key)) {
                    set.add(key);
                    dates.push(date);
                }
            });

            dates.sort((a, b) => a.getTime() - b.getTime());

            if (invalid.length) {
                showFeedback("Hay fechas invalidas en calendario: " + invalid.slice(0, 3).join(", ") + (invalid.length > 3 ? "..." : ""));
            }

            return dates;
        }

        function normalizeHistory(value) {
            if (!Array.isArray(value)) {
                return [];
            }
            return value.filter((item) => item && typeof item === "object");
        }

        function hideResults() {
            document.getElementById("results").classList.add("hidden");
            document.getElementById("calendarioResults").classList.add("hidden");
        }

        function parseInputNumber(id) {
            const raw = document.getElementById(id).value.trim().replace(",", ".");
            return Number(raw);
        }

        function setValue(id, value) {
            const element = document.getElementById(id);
            if (element) {
                element.value = value;
            }
        }

        function parseISODate(value) {
            if (!/^\d{4}-\d{2}-\d{2}$/.test(String(value))) {
                return null;
            }

            const parts = value.split("-").map(Number);
            const year = parts[0];
            const month = parts[1];
            const day = parts[2];

            const date = new Date(year, month - 1, day);
            date.setHours(0, 0, 0, 0);

            if (
                date.getFullYear() !== year ||
                date.getMonth() !== month - 1 ||
                date.getDate() !== day
            ) {
                return null;
            }

            return date;
        }

        function formatISODate(date) {
            return [
                date.getFullYear(),
                String(date.getMonth() + 1).padStart(2, "0"),
                String(date.getDate()).padStart(2, "0")
            ].join("-");
        }

        function getTodayISO() {
            return formatISODate(new Date());
        }

        function addDays(date, days) {
            const next = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            next.setDate(next.getDate() + Number(days || 0));
            next.setHours(0, 0, 0, 0);
            return next;
        }

        function addMonthsSafe(date, monthsToAdd) {
            const monthDate = new Date(date.getFullYear(), date.getMonth(), 1);
            monthDate.setMonth(monthDate.getMonth() + Number(monthsToAdd || 0));
            const lastDay = new Date(monthDate.getFullYear(), monthDate.getMonth() + 1, 0).getDate();
            monthDate.setDate(Math.min(date.getDate(), lastDay));
            monthDate.setHours(0, 0, 0, 0);
            return monthDate;
        }

        function getCalendarFrequencyConfig() {
            const value = document.getElementById("frecuenciaCalendario")?.value || "quincenal";
            if (value === "semanal") {
                return {
                    days: 7,
                    label: "semanales",
                    getDateAt: (start, index) => addDays(start, index * 7)
                };
            }

            if (value === "mensual") {
                return {
                    days: 30,
                    label: "mensuales",
                    getDateAt: (start, index) => addMonthsSafe(start, index)
                };
            }

            return {
                days: 14,
                label: "quincenales",
                getDateAt: (start, index) => addDays(start, index * 14)
            };
        }

        function diffInDays(start, end) {
            const msPerDay = 86400000;
            const startTime = new Date(start.getFullYear(), start.getMonth(), start.getDate()).getTime();
            const endTime = new Date(end.getFullYear(), end.getMonth(), end.getDate()).getTime();
            return Math.floor((endTime - startTime) / msPerDay);
        }

        function formatDisplayDate(date) {
            return date.toLocaleDateString("es-ES");
        }

        function clamp(value, min, max) {
            if (!Number.isFinite(value)) {
                return min;
            }
            return Math.min(max, Math.max(min, value));
        }

        function safeReadJSON(key, fallback) {
            try {
                const raw = localStorage.getItem(key);
                if (!raw) {
                    return fallback;
                }
                return JSON.parse(raw);
            } catch (error) {
                return fallback;
            }
        }

        function safeWriteJSON(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
                return true;
            } catch (error) {
                return false;
            }
        }

        function safeRemove(key) {
            try {
                localStorage.removeItem(key);
                return true;
            } catch (error) {
                return false;
            }
        }

        function showFeedback(message, type = "error") {
            const box = document.getElementById("feedback");
            box.className = "feedback " + (type === "success" ? "success" : "error");
            box.textContent = message;
            box.classList.remove("hidden");
        }

        function clearFeedback() {
            const box = document.getElementById("feedback");
            box.textContent = "";
            box.className = "feedback hidden";
        }

        function escapeHtml(value) {
            return String(value)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#39;");
        }

        function generarCalendarioEjemplo() {
            const inicio = parseISODate(document.getElementById("primeraFechaPago").value) || addDays(parseISODate(getTodayISO()), -120);
            const total = Number(document.getElementById("numeroTotalPagos").value || "19");
            const count = Number.isInteger(total) && total > 0 ? total : 19;
            const frecuenciaConfig = getCalendarFrequencyConfig();
            const fechas = [];

            for (let i = 0; i < count; i += 1) {
                fechas.push(formatISODate(frecuenciaConfig.getDateAt(inicio, i)));
            }

            document.getElementById("calendarioPagos").value = fechas.join("\n");
        }
    </script>
</body>
</html>
